name: Release Strict Final Gate

on:
  workflow_dispatch:
    inputs:
      deploy_to_railway:
        description: "Deploy gateway + frontend to Railway after strict gate passes"
        required: true
        type: boolean
        default: false
      railway_environment:
        description: "Railway environment name"
        required: true
        default: "production"
      gateway_public_url:
        description: "Gateway public URL for badge validation and frontend runtime derivation"
        required: true
        default: "https://live-agent-production.up.railway.app"
      gateway_demo_frontend_public_url:
        description: "Expected demo frontend public URL for gateway root descriptor uiUrl validation"
        required: false
        default: ""
      gateway_root_descriptor_check_max_attempts:
        description: "Max attempts for gateway root descriptor check"
        required: false
        default: "3"
      gateway_root_descriptor_check_retry_backoff_sec:
        description: "Retry backoff seconds for gateway root descriptor check"
        required: false
        default: "2"
      skip_gateway_deploy:
        description: "Skip gateway deploy stage in combined helper"
        required: true
        type: boolean
        default: false
      skip_frontend_deploy:
        description: "Skip frontend deploy stage in combined helper"
        required: true
        type: boolean
        default: false
      gateway_skip_root_descriptor_check:
        description: "Skip post-deploy gateway root descriptor check"
        required: true
        type: boolean
        default: false
      gateway_no_wait:
        description: "Trigger gateway deploy without waiting"
        required: true
        type: boolean
        default: false
      frontend_no_wait:
        description: "Trigger frontend deploy without waiting"
        required: true
        type: boolean
        default: false
      frontend_skip_health_check:
        description: "Skip frontend health check after deploy"
        required: true
        type: boolean
        default: false
      verify_only_fallback_on_auth_failure:
        description: "When Railway auth fails in CI, run verify-only fallback (public endpoints) instead of deploy"
        required: true
        type: boolean
        default: true
  push:
    branches:
      - main
      - master

jobs:
  release-strict-final:
    runs-on: windows-latest
    timeout-minutes: 60
    permissions:
      contents: read
    concurrency:
      group: release-strict-final-${{ github.ref }}
      cancel-in-progress: true
    env:
      FIRESTORE_ENABLED: "false"
      UI_NAVIGATOR_EXECUTOR_MODE: remote_http
      UI_NAVIGATOR_EXECUTOR_URL: http://localhost:8090
      UI_EXECUTOR_STRICT_PLAYWRIGHT: "false"
      UI_EXECUTOR_SIMULATE_IF_UNAVAILABLE: "true"
      RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN || secrets.RAILWAY_TOKEN }}
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_PROJECT_TOKEN }}
      RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
      RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
      RAILWAY_FRONTEND_SERVICE_ID: ${{ secrets.RAILWAY_FRONTEND_SERVICE_ID }}
      FRONTEND_PUBLIC_URL: ${{ vars.FRONTEND_PUBLIC_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - name: Install Dependencies
        run: npm ci
        shell: powershell

      - name: Run Release Strict Final Gate
        run: npm run verify:release:strict
        shell: powershell

      - name: Install Railway CLI
        if: github.event_name == 'workflow_dispatch' && inputs.deploy_to_railway == true
        run: npm install -g @railway/cli
        shell: powershell

      - name: Validate Railway Secrets
        if: github.event_name == 'workflow_dispatch' && inputs.deploy_to_railway == true
        shell: powershell
        run: |
          if ([string]::IsNullOrWhiteSpace($env:RAILWAY_API_TOKEN)) {
            throw "Missing required repository secret: RAILWAY_API_TOKEN (or legacy RAILWAY_TOKEN)"
          }
          if ([string]::IsNullOrWhiteSpace($env:RAILWAY_PROJECT_ID)) {
            throw "Missing required repository secret: RAILWAY_PROJECT_ID"
          }
          if ([string]::IsNullOrWhiteSpace($env:RAILWAY_SERVICE_ID)) {
            throw "Missing required repository secret: RAILWAY_SERVICE_ID"
          }

      - name: Probe Railway Auth
        id: railway_auth_probe
        if: github.event_name == 'workflow_dispatch' && inputs.deploy_to_railway == true
        continue-on-error: true
        shell: powershell
        run: railway whoami

      - name: Deploy To Railway (Gateway + Frontend)
        id: combined_deploy
        if: github.event_name == 'workflow_dispatch' && inputs.deploy_to_railway == true
        continue-on-error: true
        shell: powershell
        run: |
          $args = @(
            "--",
            "-ProjectId", $env:RAILWAY_PROJECT_ID,
            "-GatewayServiceId", $env:RAILWAY_SERVICE_ID,
            "-Environment", "${{ inputs.railway_environment }}",
            "-GatewayPublicUrl", "${{ inputs.gateway_public_url }}",
            "-SkipReleaseVerification"
          )

          $gatewayDemoFrontendPublicUrl = "${{ inputs.gateway_demo_frontend_public_url }}".Trim()
          if ([string]::IsNullOrWhiteSpace($gatewayDemoFrontendPublicUrl) -and -not [string]::IsNullOrWhiteSpace($env:FRONTEND_PUBLIC_URL)) {
            $gatewayDemoFrontendPublicUrl = $env:FRONTEND_PUBLIC_URL.Trim().TrimEnd("/")
          }
          if (-not [string]::IsNullOrWhiteSpace($gatewayDemoFrontendPublicUrl)) {
            $args += @("-GatewayDemoFrontendPublicUrl", $gatewayDemoFrontendPublicUrl)
          }
          if (-not [string]::IsNullOrWhiteSpace("${{ inputs.gateway_root_descriptor_check_max_attempts }}")) {
            $args += @("-GatewayRootDescriptorCheckMaxAttempts", "${{ inputs.gateway_root_descriptor_check_max_attempts }}")
          }
          if (-not [string]::IsNullOrWhiteSpace("${{ inputs.gateway_root_descriptor_check_retry_backoff_sec }}")) {
            $args += @("-GatewayRootDescriptorCheckRetryBackoffSec", "${{ inputs.gateway_root_descriptor_check_retry_backoff_sec }}")
          }

          if (-not [string]::IsNullOrWhiteSpace($env:RAILWAY_FRONTEND_SERVICE_ID)) {
            $args += @("-FrontendService", $env:RAILWAY_FRONTEND_SERVICE_ID)
          }

          if ("${{ inputs.skip_gateway_deploy }}" -eq "true") {
            $args += "-SkipGatewayDeploy"
          }
          if ("${{ inputs.skip_frontend_deploy }}" -eq "true") {
            $args += "-SkipFrontendDeploy"
          }
          if ("${{ inputs.gateway_skip_root_descriptor_check }}" -eq "true") {
            $args += "-GatewaySkipRootDescriptorCheck"
          }
          if ("${{ inputs.gateway_no_wait }}" -eq "true") {
            $args += "-GatewayNoWait"
          }
          if ("${{ inputs.frontend_no_wait }}" -eq "true") {
            $args += "-FrontendNoWait"
          }
          if ("${{ inputs.frontend_skip_health_check }}" -eq "true") {
            $args += "-FrontendSkipHealthCheck"
          }

          npm run deploy:railway:all @args

      - name: Verify Public Endpoints Fallback (Deploy Failure)
        id: verify_only_fallback
        if: github.event_name == 'workflow_dispatch' && inputs.deploy_to_railway == true && steps.combined_deploy.outcome != 'success' && inputs.verify_only_fallback_on_auth_failure == true
        shell: powershell
        run: |
          Write-Warning "Railway deploy failed; running verify-only fallback."

          $gatewayPublicUrl = "${{ inputs.gateway_public_url }}".Trim().TrimEnd("/")
          if ([string]::IsNullOrWhiteSpace($gatewayPublicUrl)) {
            throw "gateway_public_url is required for verify-only fallback."
          }

          npm run badge:public:check -- -RailwayPublicUrl $gatewayPublicUrl

          $frontendShouldBeChecked = ("${{ inputs.skip_frontend_deploy }}" -ne "true") -and ("${{ inputs.frontend_skip_health_check }}" -ne "true")
          if ($frontendShouldBeChecked) {
            $frontendBaseUrl = if (-not [string]::IsNullOrWhiteSpace($env:FRONTEND_PUBLIC_URL)) {
              $env:FRONTEND_PUBLIC_URL.Trim().TrimEnd("/")
            } else {
              "https://live-agent-frontend-production.up.railway.app"
            }

            $frontendHealth = Invoke-RestMethod -Method Get -Uri ($frontendBaseUrl + "/healthz") -TimeoutSec 20
            if ($null -eq $frontendHealth -or $frontendHealth.ok -ne $true) {
              throw ("Frontend fallback health check failed for " + $frontendBaseUrl + "/healthz")
            }
            Write-Host ("Frontend fallback health check passed: " + $frontendBaseUrl + "/healthz")
          } else {
            Write-Host "Frontend fallback health check skipped by workflow inputs."
          }

      - name: Fail on Railway Deploy
        if: github.event_name == 'workflow_dispatch' && inputs.deploy_to_railway == true && steps.combined_deploy.outcome != 'success' && inputs.verify_only_fallback_on_auth_failure != true
        shell: powershell
        run: |
          throw "Railway deploy failed and verify_only_fallback_on_auth_failure=false."

      - name: Publish Railway Deploy Mode Summary
        if: always()
        shell: powershell
        run: |
          $deployMode = if ("${{ github.event_name }}" -ne "workflow_dispatch" -or "${{ inputs.deploy_to_railway }}" -ne "true") {
            "not_requested"
          } elseif ("${{ steps.combined_deploy.outcome }}" -eq "success") {
            "real_deploy"
          } elseif ("${{ steps.verify_only_fallback.outcome }}" -eq "success") {
            "verify_only_fallback"
          } else {
            "deploy_failed_no_fallback"
          }

          Write-Host ("railway_deploy_mode=" + $deployMode)
          ("railway_deploy_mode=" + $deployMode) | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append

      - name: Publish Release Report To Job Summary
        if: always()
        shell: powershell
        run: |
          if (Test-Path "artifacts/demo-e2e/summary.md") {
            Get-Content "artifacts/demo-e2e/summary.md" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          } else {
            "Demo report was not generated." | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          }
          if (Test-Path "artifacts/demo-e2e/policy-check.md") {
            "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
            Get-Content "artifacts/demo-e2e/policy-check.md" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          }
          if (Test-Path "artifacts/demo-e2e/policy-check.json") {
            $policy = Get-Content "artifacts/demo-e2e/policy-check.json" -Raw | ConvertFrom-Json
            "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
            ("Policy gate status: " + ($(if ($policy.ok) { "passed" } else { "failed" }))) | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
            ("Policy checks: " + $policy.checks + ", violations: " + $policy.violations.Count) | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          }
          if (Test-Path "artifacts/demo-e2e/badge.json") {
            $badge = Get-Content "artifacts/demo-e2e/badge.json" -Raw | ConvertFrom-Json
            ("Badge: " + $badge.label + " -> " + $badge.message + " (" + $badge.color + ")") | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          }
          if (Test-Path "artifacts/perf-load/policy-check.json") {
            $perf = Get-Content "artifacts/perf-load/policy-check.json" -Raw | ConvertFrom-Json
            ("Perf policy gate: " + ($(if ($perf.ok) { "passed" } else { "failed" })) + " (" + $perf.checks + " checks)") | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          }

      - name: Upload Release Strict Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-strict-final-artifacts
          path: |
            artifacts/demo-e2e/summary.json
            artifacts/demo-e2e/summary.md
            artifacts/demo-e2e/policy-check.md
            artifacts/demo-e2e/policy-check.json
            artifacts/demo-e2e/badge.json
            artifacts/demo-e2e/badge-details.json
            artifacts/demo-e2e/logs
            artifacts/perf-load/summary.json
            artifacts/perf-load/summary.md
            artifacts/perf-load/policy-check.json
            artifacts/perf-load/policy-check.md
            artifacts/perf-load/logs
          if-no-files-found: warn

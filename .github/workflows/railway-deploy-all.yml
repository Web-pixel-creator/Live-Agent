name: Railway Deploy All

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Railway environment name"
        required: true
        default: "production"
      gateway_public_url:
        description: "Gateway public base URL for badge check and frontend runtime derivation"
        required: true
        default: "https://live-agent-production.up.railway.app"
      gateway_demo_frontend_public_url:
        description: "Expected demo frontend public URL for gateway root descriptor uiUrl validation"
        required: false
        default: ""
      gateway_root_descriptor_check_max_attempts:
        description: "Max attempts for gateway root descriptor check"
        required: false
        default: "3"
      gateway_root_descriptor_check_retry_backoff_sec:
        description: "Retry backoff seconds for gateway root descriptor check"
        required: false
        default: "2"
      skip_release_verification:
        description: "Skip local release gate before gateway deploy"
        required: true
        type: boolean
        default: true
      skip_gateway_deploy:
        description: "Skip gateway deploy step"
        required: true
        type: boolean
        default: false
      skip_frontend_deploy:
        description: "Skip frontend deploy step"
        required: true
        type: boolean
        default: false
      gateway_skip_root_descriptor_check:
        description: "Skip post-deploy gateway root descriptor check"
        required: true
        type: boolean
        default: false
      gateway_no_wait:
        description: "Trigger gateway deploy and exit without waiting"
        required: true
        type: boolean
        default: false
      frontend_no_wait:
        description: "Trigger frontend deploy and exit without waiting"
        required: true
        type: boolean
        default: false
      frontend_skip_health_check:
        description: "Skip frontend /healthz check"
        required: true
        type: boolean
        default: false
      verify_only_fallback_on_auth_failure:
        description: "When Railway auth fails in CI, run verify-only fallback (public endpoints) instead of deploy"
        required: true
        type: boolean
        default: true

jobs:
  deploy:
    runs-on: windows-latest
    timeout-minutes: 45
    permissions:
      contents: read
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
      RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
      RAILWAY_FRONTEND_SERVICE_ID: ${{ secrets.RAILWAY_FRONTEND_SERVICE_ID }}
      FRONTEND_PUBLIC_URL: ${{ vars.FRONTEND_PUBLIC_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - name: Install Dependencies
        run: npm ci
        shell: powershell

      - name: Install Railway CLI
        run: npm install -g @railway/cli
        shell: powershell

      - name: Validate Railway Secrets
        shell: powershell
        run: |
          if ([string]::IsNullOrWhiteSpace($env:RAILWAY_TOKEN)) {
            throw "Missing required repository secret: RAILWAY_TOKEN"
          }
          if ([string]::IsNullOrWhiteSpace($env:RAILWAY_PROJECT_ID)) {
            throw "Missing required repository secret: RAILWAY_PROJECT_ID"
          }
          if ([string]::IsNullOrWhiteSpace($env:RAILWAY_SERVICE_ID)) {
            throw "Missing required repository secret: RAILWAY_SERVICE_ID"
          }

      - name: Probe Railway Auth
        id: railway_auth_probe
        continue-on-error: true
        shell: powershell
        run: railway whoami

      - name: Run Combined Railway Deploy
        if: steps.railway_auth_probe.outcome == 'success'
        shell: powershell
        run: |
          $args = @(
            "--",
            "-ProjectId", $env:RAILWAY_PROJECT_ID,
            "-GatewayServiceId", $env:RAILWAY_SERVICE_ID,
            "-Environment", "${{ inputs.environment }}",
            "-GatewayPublicUrl", "${{ inputs.gateway_public_url }}"
          )

          if (-not [string]::IsNullOrWhiteSpace("${{ inputs.gateway_demo_frontend_public_url }}")) {
            $args += @("-GatewayDemoFrontendPublicUrl", "${{ inputs.gateway_demo_frontend_public_url }}")
          }
          if (-not [string]::IsNullOrWhiteSpace("${{ inputs.gateway_root_descriptor_check_max_attempts }}")) {
            $args += @("-GatewayRootDescriptorCheckMaxAttempts", "${{ inputs.gateway_root_descriptor_check_max_attempts }}")
          }
          if (-not [string]::IsNullOrWhiteSpace("${{ inputs.gateway_root_descriptor_check_retry_backoff_sec }}")) {
            $args += @("-GatewayRootDescriptorCheckRetryBackoffSec", "${{ inputs.gateway_root_descriptor_check_retry_backoff_sec }}")
          }

          if (-not [string]::IsNullOrWhiteSpace($env:RAILWAY_FRONTEND_SERVICE_ID)) {
            $args += @("-FrontendService", $env:RAILWAY_FRONTEND_SERVICE_ID)
          }

          if ("${{ inputs.skip_release_verification }}" -eq "true") {
            $args += "-SkipReleaseVerification"
          }
          if ("${{ inputs.skip_gateway_deploy }}" -eq "true") {
            $args += "-SkipGatewayDeploy"
          }
          if ("${{ inputs.skip_frontend_deploy }}" -eq "true") {
            $args += "-SkipFrontendDeploy"
          }
          if ("${{ inputs.gateway_skip_root_descriptor_check }}" -eq "true") {
            $args += "-GatewaySkipRootDescriptorCheck"
          }
          if ("${{ inputs.gateway_no_wait }}" -eq "true") {
            $args += "-GatewayNoWait"
          }
          if ("${{ inputs.frontend_no_wait }}" -eq "true") {
            $args += "-FrontendNoWait"
          }
          if ("${{ inputs.frontend_skip_health_check }}" -eq "true") {
            $args += "-FrontendSkipHealthCheck"
          }

          npm run deploy:railway:all @args

      - name: Verify Public Endpoints Fallback (Auth Failure)
        if: steps.railway_auth_probe.outcome != 'success' && inputs.verify_only_fallback_on_auth_failure == true
        shell: powershell
        run: |
          Write-Warning "Railway auth probe failed; running verify-only fallback."

          $gatewayPublicUrl = "${{ inputs.gateway_public_url }}".Trim().TrimEnd("/")
          if ([string]::IsNullOrWhiteSpace($gatewayPublicUrl)) {
            throw "gateway_public_url is required for verify-only fallback."
          }

          npm run badge:public:check -- -RailwayPublicUrl $gatewayPublicUrl

          $frontendShouldBeChecked = ("${{ inputs.skip_frontend_deploy }}" -ne "true") -and ("${{ inputs.frontend_skip_health_check }}" -ne "true")
          if ($frontendShouldBeChecked) {
            $frontendBaseUrl = if (-not [string]::IsNullOrWhiteSpace($env:FRONTEND_PUBLIC_URL)) {
              $env:FRONTEND_PUBLIC_URL.Trim().TrimEnd("/")
            } else {
              "https://live-agent-frontend-production.up.railway.app"
            }

            $frontendHealth = Invoke-RestMethod -Method Get -Uri ($frontendBaseUrl + "/healthz") -TimeoutSec 20
            if ($null -eq $frontendHealth -or $frontendHealth.ok -ne $true) {
              throw ("Frontend fallback health check failed for " + $frontendBaseUrl + "/healthz")
            }
            Write-Host ("Frontend fallback health check passed: " + $frontendBaseUrl + "/healthz")
          } else {
            Write-Host "Frontend fallback health check skipped by workflow inputs."
          }

      - name: Fail on Railway Auth Probe
        if: steps.railway_auth_probe.outcome != 'success' && inputs.verify_only_fallback_on_auth_failure != true
        shell: powershell
        run: |
          throw "Railway auth probe failed and verify_only_fallback_on_auth_failure=false."

      - name: Publish Railway Deploy Mode Summary
        if: always()
        shell: powershell
        run: |
          $deployMode = if ("${{ steps.railway_auth_probe.outcome }}" -eq "success") {
            "real_deploy"
          } elseif ("${{ inputs.verify_only_fallback_on_auth_failure }}" -eq "true") {
            "verify_only_fallback"
          } else {
            "auth_failed_no_fallback"
          }

          Write-Host ("railway_deploy_mode=" + $deployMode)
          ("railway_deploy_mode=" + $deployMode) | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append

name: PR Quality Gate

on:
  pull_request:

jobs:
  pr-quality:
    runs-on: windows-latest
    timeout-minutes: 35
    permissions:
      contents: read
    env:
      FIRESTORE_ENABLED: "false"
      UI_NAVIGATOR_EXECUTOR_MODE: remote_http
      UI_NAVIGATOR_EXECUTOR_URL: http://localhost:8090
      UI_EXECUTOR_STRICT_PLAYWRIGHT: "false"
      UI_EXECUTOR_SIMULATE_IF_UNAVAILABLE: "true"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - name: Install Dependencies
        run: npm ci
        shell: powershell

      - name: Build Workspaces
        run: npm run build
        shell: powershell

      - name: Run Unit Tests
        run: npm run test:unit
        shell: powershell

      - name: Run Runtime Profile Smoke
        run: npm run profile:smoke
        shell: powershell

      - name: Validate Monitoring Templates
        run: npm run infra:monitoring:validate
        shell: powershell

      - name: Run Demo E2E (Fast)
        run: npm run demo:e2e:fast
        shell: powershell

      - name: Validate Demo KPI Policy
        run: >
          node ./scripts/demo-e2e-policy-check.mjs
          --input ./artifacts/demo-e2e/summary.json
          --output ./artifacts/demo-e2e/policy-check.md
          --jsonOutput ./artifacts/demo-e2e/policy-check.json
          --maxGatewayWsRoundTripMs 1800
          --minApprovalsRecorded 1
          --expectedUiAdapterMode remote_http
          --allowedUiAdapterModes remote_http,simulated
          --allowedGatewayInterruptEvents live.interrupt.requested,live.bridge.unavailable
          --allowedTranslationProviders fallback,gemini
        shell: powershell

      - name: Build Badge Artifact
        run: npm run demo:e2e:badge
        shell: powershell

      - name: Publish Demo Report To Job Summary
        if: always()
        shell: powershell
        run: |
          if (Test-Path "artifacts/demo-e2e/summary.md") {
            Get-Content "artifacts/demo-e2e/summary.md" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          } else {
            "Demo report was not generated." | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          }
          if (Test-Path "artifacts/demo-e2e/policy-check.md") {
            "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
            Get-Content "artifacts/demo-e2e/policy-check.md" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          }
          if (Test-Path "artifacts/demo-e2e/policy-check.json") {
            $policy = Get-Content "artifacts/demo-e2e/policy-check.json" -Raw | ConvertFrom-Json
            "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
            ("Policy gate status: " + ($(if ($policy.ok) { "passed" } else { "failed" }))) | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
            ("Policy checks: " + $policy.checks + ", violations: " + $policy.violations.Count) | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          }
          if (Test-Path "artifacts/demo-e2e/badge.json") {
            $badge = Get-Content "artifacts/demo-e2e/badge.json" -Raw | ConvertFrom-Json
            ("Badge: " + $badge.label + " -> " + $badge.message + " (" + $badge.color + ")") | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          }

      - name: Upload Demo Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-quality-artifacts
          path: |
            artifacts/demo-e2e/summary.json
            artifacts/demo-e2e/summary.md
            artifacts/demo-e2e/policy-check.md
            artifacts/demo-e2e/policy-check.json
            artifacts/demo-e2e/badge.json
            artifacts/demo-e2e/badge-details.json
            artifacts/demo-e2e/logs
          if-no-files-found: warn

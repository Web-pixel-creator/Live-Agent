name: Release Artifact Revalidation

on:
  workflow_dispatch:
    inputs:
      source_run_id:
        description: Optional source workflow run ID containing release artifacts
        required: false
        type: string
      artifact_name:
        description: Optional artifact bundle name (auto-detected if omitted)
        required: false
        type: string
      perf_gate_mode:
        description: Perf gate mode for artifact-only revalidation (auto/with_perf/without_perf)
        required: false
        default: auto
        type: choice
        options:
          - auto
          - with_perf
          - without_perf
      strict_final_run:
        description: Enforce strict artifact gate (scenario retries must remain zero)
        required: false
        default: false
        type: boolean

jobs:
  release-artifact-revalidation:
    runs-on: windows-latest
    timeout-minutes: 30
    permissions:
      contents: read
      actions: read
    concurrency:
      group: release-artifact-revalidation-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - name: Resolve Source Run and Artifact
        id: resolve_source
        uses: actions/github-script@v7
        with:
          script: |
            const sourceRunIdRaw = core.getInput("source_run_id").trim();
            const artifactNameRaw = core.getInput("artifact_name").trim();
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            let resolvedRunId = sourceRunIdRaw || null;
            if (!resolvedRunId) {
              const candidates = [];
              const workflowIds = ["demo-e2e.yml", "release-strict-final.yml"];
              for (const workflowId of workflowIds) {
                const response = await github.rest.actions.listWorkflowRuns({
                  owner,
                  repo,
                  workflow_id: workflowId,
                  status: "completed",
                  per_page: 20
                });

                for (const run of response.data.workflow_runs || []) {
                  if (run.conclusion !== "success") {
                    continue;
                  }
                  if (run.head_branch !== "main" && run.head_branch !== "master") {
                    continue;
                  }
                  candidates.push({
                    runId: String(run.id),
                    updatedAt: run.updated_at || run.created_at || "",
                    workflowId
                  });
                }
              }

              if (candidates.length === 0) {
                core.setFailed("No successful main/master runs found for demo-e2e.yml or release-strict-final.yml.");
                return;
              }

              candidates.sort((a, b) => new Date(b.updatedAt).getTime() - new Date(a.updatedAt).getTime());
              resolvedRunId = candidates[0].runId;
              core.info(`Auto-selected run ${resolvedRunId} from ${candidates[0].workflowId}`);
            }

            const parsedRunId = Number(resolvedRunId);
            if (!Number.isFinite(parsedRunId) || parsedRunId <= 0) {
              core.setFailed(`Invalid run id: ${resolvedRunId}`);
              return;
            }

            let resolvedArtifactName = artifactNameRaw || null;
            if (!resolvedArtifactName) {
              const artifactsResponse = await github.rest.actions.listWorkflowRunArtifacts({
                owner,
                repo,
                run_id: parsedRunId,
                per_page: 100
              });

              const availableArtifacts = (artifactsResponse.data.artifacts || [])
                .filter((artifact) => !artifact.expired)
                .map((artifact) => artifact.name);
              const preferredOrder = [
                "release-strict-final-artifacts",
                "demo-e2e-artifacts",
                "pr-quality-artifacts"
              ];
              resolvedArtifactName = preferredOrder.find((name) => availableArtifacts.includes(name)) || null;

              if (!resolvedArtifactName) {
                core.setFailed(
                  `No supported artifact bundle found in run ${parsedRunId}. Available: ${availableArtifacts.join(", ")}`
                );
                return;
              }
            }

            core.setOutput("run_id", String(parsedRunId));
            core.setOutput("artifact_name", resolvedArtifactName);
            core.info(`Using run ${parsedRunId}, artifact ${resolvedArtifactName}`);

      - name: Download Source Artifact Bundle
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.resolve_source.outputs.run_id }}
          name: ${{ steps.resolve_source.outputs.artifact_name }}
          path: artifact-bundle

      - name: Prepare Local Artifact Paths
        shell: powershell
        run: |
          if (-not (Test-Path "artifact-bundle/artifacts")) {
            Write-Error "Downloaded artifact does not contain expected artifacts/ directory."
            exit 1
          }
          New-Item -Path "artifacts" -ItemType Directory -Force | Out-Null
          Copy-Item -Path "artifact-bundle/artifacts/*" -Destination "artifacts/" -Recurse -Force

      - name: Inspect Restored Artifact Set
        id: inspect_artifacts
        shell: powershell
        run: |
          $requestedPerfMode = "${{ github.event.inputs.perf_gate_mode }}"
          if ([string]::IsNullOrWhiteSpace($requestedPerfMode)) {
            $requestedPerfMode = "auto"
          }
          $requestedPerfMode = $requestedPerfMode.ToLowerInvariant()
          if (@("auto", "with_perf", "without_perf") -notcontains $requestedPerfMode) {
            Write-Error "Unsupported perf_gate_mode: $requestedPerfMode. Allowed values: auto|with_perf|without_perf."
            exit 1
          }

          $perfSummaryExists = Test-Path "artifacts/perf-load/summary.json"
          $perfPolicyExists = Test-Path "artifacts/perf-load/policy-check.json"
          $hasPerfArtifacts = $perfSummaryExists -and $perfPolicyExists

          $runWithPerf = $false
          $effectivePerfMode = "without_perf"
          switch ($requestedPerfMode) {
            "with_perf" {
              if (-not $hasPerfArtifacts) {
                Write-Error "perf_gate_mode=with_perf requires artifacts/perf-load/summary.json and artifacts/perf-load/policy-check.json."
                exit 1
              }
              $runWithPerf = $true
              $effectivePerfMode = "with_perf"
            }
            "without_perf" {
              $runWithPerf = $false
              $effectivePerfMode = "without_perf"
            }
            default {
              $runWithPerf = $hasPerfArtifacts
              $effectivePerfMode = if ($runWithPerf) { "with_perf" } else { "without_perf" }
            }
          }

          $requestedStrictRaw = "${{ github.event.inputs.strict_final_run }}"
          if ([string]::IsNullOrWhiteSpace($requestedStrictRaw)) {
            $requestedStrictRaw = "false"
          }
          $requestedStrictMode = $requestedStrictRaw.ToLowerInvariant()
          if (@("true", "false") -notcontains $requestedStrictMode) {
            Write-Error "Unsupported strict_final_run value: $requestedStrictRaw. Allowed values: true|false."
            exit 1
          }

          "requested_perf_mode=$requestedPerfMode" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "has_perf_artifacts=$($hasPerfArtifacts.ToString().ToLowerInvariant())" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "run_with_perf=$($runWithPerf.ToString().ToLowerInvariant())" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "effective_perf_mode=$effectivePerfMode" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "strict_final_run=$requestedStrictMode" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

          if ($runWithPerf) {
            Write-Host "Perf gate mode: $effectivePerfMode (requested=$requestedPerfMode, hasPerfArtifacts=$hasPerfArtifacts). strict_final_run=$requestedStrictMode."
          } else {
            Write-Host "Perf gate mode: $effectivePerfMode (requested=$requestedPerfMode, hasPerfArtifacts=$hasPerfArtifacts). strict_final_run=$requestedStrictMode. Running with -SkipPerfLoad."
          }

      - name: Run Artifact-Only Release Revalidation (With Perf Artifacts, Standard)
        if: steps.inspect_artifacts.outputs.run_with_perf == 'true' && steps.inspect_artifacts.outputs.strict_final_run != 'true'
        run: npm run verify:release:artifact-only
        shell: powershell

      - name: Run Artifact-Only Release Revalidation (With Perf Artifacts, Strict)
        if: steps.inspect_artifacts.outputs.run_with_perf == 'true' && steps.inspect_artifacts.outputs.strict_final_run == 'true'
        run: >
          powershell -NoProfile -ExecutionPolicy Bypass -File ./scripts/release-readiness.ps1
          -SkipBuild -SkipUnitTests -SkipMonitoringTemplates -SkipProfileSmoke -SkipDemoE2E -SkipPolicy -SkipBadge -SkipPerfRun -StrictFinalRun
        shell: powershell

      - name: Run Artifact-Only Release Revalidation (No Perf Artifacts, Standard)
        if: steps.inspect_artifacts.outputs.run_with_perf != 'true' && steps.inspect_artifacts.outputs.strict_final_run != 'true'
        run: >
          powershell -NoProfile -ExecutionPolicy Bypass -File ./scripts/release-readiness.ps1
          -SkipBuild -SkipUnitTests -SkipMonitoringTemplates -SkipProfileSmoke -SkipDemoE2E -SkipPolicy -SkipBadge -SkipPerfLoad -SkipPerfRun
        shell: powershell

      - name: Run Artifact-Only Release Revalidation (No Perf Artifacts, Strict)
        if: steps.inspect_artifacts.outputs.run_with_perf != 'true' && steps.inspect_artifacts.outputs.strict_final_run == 'true'
        run: >
          powershell -NoProfile -ExecutionPolicy Bypass -File ./scripts/release-readiness.ps1
          -SkipBuild -SkipUnitTests -SkipMonitoringTemplates -SkipProfileSmoke -SkipDemoE2E -SkipPolicy -SkipBadge -SkipPerfLoad -SkipPerfRun -StrictFinalRun
        shell: powershell

      - name: Publish Artifact Revalidation Summary
        if: always()
        shell: powershell
        run: |
          ("Source run id: ${{ steps.resolve_source.outputs.run_id }}") | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          ("Artifact bundle: ${{ steps.resolve_source.outputs.artifact_name }}") | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          ("Requested perf mode: ${{ steps.inspect_artifacts.outputs.requested_perf_mode }}") | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          ("Strict final run: ${{ steps.inspect_artifacts.outputs.strict_final_run }}") | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          ("Perf artifacts detected: ${{ steps.inspect_artifacts.outputs.has_perf_artifacts }}") | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          ("Effective perf mode: ${{ steps.inspect_artifacts.outputs.effective_perf_mode }}") | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          if (Test-Path "artifacts/demo-e2e/summary.md") {
            "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
            Get-Content "artifacts/demo-e2e/summary.md" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          }
          if (Test-Path "artifacts/demo-e2e/policy-check.md") {
            "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
            Get-Content "artifacts/demo-e2e/policy-check.md" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          }
          if (Test-Path "artifacts/perf-load/policy-check.md") {
            "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
            Get-Content "artifacts/perf-load/policy-check.md" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          }

      - name: Upload Revalidation Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-artifact-revalidation-artifacts
          path: |
            artifacts/demo-e2e/summary.json
            artifacts/demo-e2e/summary.md
            artifacts/demo-e2e/policy-check.md
            artifacts/demo-e2e/policy-check.json
            artifacts/demo-e2e/badge.json
            artifacts/demo-e2e/badge-details.json
            artifacts/perf-load/summary.json
            artifacts/perf-load/summary.md
            artifacts/perf-load/policy-check.json
            artifacts/perf-load/policy-check.md
          if-no-files-found: warn
